"use strict";(()=>{var e={};e.id=673,e.ids=[673],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},18308:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>y,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>v,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>p});var o=r(49303),n=r(88716),i=r(60670),a=r(87070),u=r(30474);async function p(e,{params:t}){try{let r=(0,u.R)(),{data:{user:s},error:o}=await r.auth.getUser();if(!s||o)return a.NextResponse.json({error:"No autorizado"},{status:401});let{data:n,error:i}=await r.from("surveys").select("id, title").eq("id",t.id).eq("owner_id",s.id).single();if(i||!n)return a.NextResponse.json({error:"Encuesta no encontrada o no autorizado"},{status:404});let{searchParams:p}=new URL(e.url),c=p.get("format")||"csv",{data:d,error:x}=await r.from("survey_questions").select("id, question_text, type, position").eq("survey_id",t.id).order("position");x&&console.error("Error fetching questions:",x);let{data:v,error:m}=await r.from("responses").select(`
        id,
        submitted_at,
        respondent_token,
        meta,
        response_items (
          question_id,
          value_text,
          value_numeric,
          value_json
        )
      `).eq("survey_id",t.id).order("submitted_at",{ascending:!1});if(m&&console.error("Error fetching responses:",m),"csv"===c){let e=function(e,t,r){let s=["ID Respuesta","Fecha y Hora","Token Respuesta","Tipo Dispositivo","Navegador","Sistema Operativo",...e.map(e=>`"${l(e.question_text)}"`)],o=t.map(t=>{let r=t.meta||{},s=[t.id,new Date(t.submitted_at).toISOString(),t.respondent_token||"",r.is_mobile?"M\xf3vil":r.is_tablet?"Tablet":"Desktop",r.browser||"",r.os||""];return e.forEach(e=>{let r=t.response_items?.find(t=>t.question_id===e.id);if(r){let e="";r.value_text?e=r.value_text:null!==r.value_numeric&&void 0!==r.value_numeric?e=r.value_numeric.toString():r.value_json&&(e=Array.isArray(r.value_json)?r.value_json.join("; "):JSON.stringify(r.value_json)),s.push(`"${l(e)}"`)}else s.push("")}),s.join(",")});return[s.join(","),...o].join("\n")}(d||[],v||[],0);return new a.NextResponse(e,{headers:{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="encuesta_${n.title.replace(/[^\w\s]/gi,"")}_${new Date().toISOString().split("T")[0]}.csv"`}})}if("json"===c)return a.NextResponse.json({success:!0,data:{survey:n,questions:d||[],responses:v||[],metadata:{exported_at:new Date().toISOString(),total_responses:v?.length||0,total_questions:d?.length||0}}});return a.NextResponse.json({error:"Formato no soportado. Use csv o json."},{status:400})}catch(e){return console.error("Error en export endpoint:",e),a.NextResponse.json({error:"Error interno del servidor"},{status:500})}}function l(e){return e.replace(/"/g,'""')}let c=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/surveys/[id]/analytics/export/route",pathname:"/api/surveys/[id]/analytics/export",filename:"route",bundlePath:"app/api/surveys/[id]/analytics/export/route"},resolvedPagePath:"C:\\Projects\\MM100922-DevOps-QR\\app\\api\\surveys\\[id]\\analytics\\export\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:x,serverHooks:v}=c,m="/api/surveys/[id]/analytics/export/route";function y(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:x})}},30474:(e,t,r)=>{r.d(t,{R:()=>n});var s=r(71615),o=r(16510);function n(){let e=(0,s.cookies)();return(0,o.createServerClient)("https://jfagkzxzkbslpohhojuh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmYWdrenh6a2JzbHBvaGhvanVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDIyNjQsImV4cCI6MjA3ODAxODI2NH0.y8rKE8CyNK54GkqRRDalX5hyPy1YrG8NVj6mr2sgKPU",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:s})=>{e.set(t,r,s)})}catch{}}}})}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,223,972],()=>r(18308));module.exports=s})();