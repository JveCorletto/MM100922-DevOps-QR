"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},4916:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{GET:()=>u});var o=r(49303),n=r(88716),a=r(60670),i=r(87070),l=r(30474);async function u(e,{params:t}){try{let e=(0,l.R)(),{data:{user:r},error:s}=await e.auth.getUser();if(!r||s)return i.NextResponse.json({error:"No autorizado"},{status:401});let{data:o,error:n}=await e.from("surveys").select(`
        *,
        profiles!surveys_owner_id_fkey (id, display_name)
      `).eq("id",t.id).eq("owner_id",r.id).single();if(n||!o)return i.NextResponse.json({error:"Encuesta no encontrada o no autorizado"},{status:404});let{count:a,error:u}=await e.from("responses").select("id",{count:"exact",head:!0}).eq("survey_id",t.id);u&&console.error("Error counting responses:",u);let{data:d,error:_}=await e.from("survey_questions").select(`
        *,
        survey_options (
          id,
          label,
          value,
          position
        )
      `).eq("survey_id",t.id).order("position",{ascending:!0});_&&console.error("Error fetching questions:",_);let{data:g,error:h}=await e.from("responses").select(`
        id,
        submitted_at,
        meta,
        response_items (
          question_id,
          value_text,
          value_numeric,
          value_json
        )
      `).eq("survey_id",t.id).order("submitted_at",{ascending:!1});h&&console.error("Error fetching responses:",h);let m=await c(d||[],g||[]),v=function(e){let t={mobile:0,desktop:0,tablet:0,browsers:{},operating_systems:{},total:e.length};e.forEach(e=>{let r=e.meta||{};if(r.is_mobile?t.mobile++:r.is_tablet?t.tablet++:t.desktop++,r.browser){let e=r.browser.split(" ")[0];t.browsers[e]=(t.browsers[e]||0)+1}r.os&&(t.operating_systems[r.os]=(t.operating_systems[r.os]||0)+1)});let r=t.total||1;return{...t,mobile_percentage:r>0?parseFloat((t.mobile/r*100).toFixed(1)):0,desktop_percentage:r>0?parseFloat((t.desktop/r*100).toFixed(1)):0,tablet_percentage:r>0?parseFloat((t.tablet/r*100).toFixed(1)):0,top_browser:Object.entries(t.browsers).sort((e,t)=>t[1]-e[1])[0]?.[0]||"Desconocido",top_os:Object.entries(t.operating_systems).sort((e,t)=>t[1]-e[1])[0]?.[0]||"Desconocido"}}(g||[]),f=await p(e,t.id),y={success:!0,data:{survey:{id:o.id,title:o.title,status:o.status,description:o.description,created_at:o.created_at,published_at:o.publish_at,total_responses:a||0},summary:{total_responses:a||0,completion_rate:function(e,t){if(0===t.length||0===e)return 0;let r=0;return t.forEach(t=>{let s=t.response_items?.length||0;r+=s/e}),parseFloat((r/t.length*100).toFixed(1))}(d?.length||0,g||[]),avg_response_time:function(e){if(0===e.length)return"0";let t=e.reduce((e,t)=>e+(t.response_items?.length||0),0)/e.length*15,r=Math.floor(t/60);return r>0?`${r}m`:`${Math.round(t)}s`}(g||[]),device_stats:v,response_trend:f},questions:m,raw_responses_count:g?.length||0}};return i.NextResponse.json(y)}catch(e){return console.error("Error en analytics endpoint:",e),i.NextResponse.json({error:"Error interno del servidor",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function c(e,t){return Promise.all(e.map(async e=>{let r;let s=t.flatMap(t=>t.response_items?.filter(t=>t.question_id===e.id)||[]);switch(e.type){case"single":r=function(e,t){let r={};e.survey_options&&e.survey_options.length>0&&e.survey_options.forEach(e=>{r[e.label||e.value||""]=0}),t.forEach(e=>{if(e.value_text){let t=e.value_text;r[t]=(r[t]||0)+1}});let s=t.length,o=Object.entries(r).map(([e,t])=>({option:e,count:t,percentage:s>0?parseFloat((t/s*100).toFixed(1)):0}));return{chart_data:o,total_responses:s,most_selected:o.length>0?o.reduce((e,t)=>t.count>e.count?t:e):null}}(e,s);break;case"multiple":r=function(e,t){let r={},s=0;e.survey_options&&e.survey_options.length>0&&e.survey_options.forEach(e=>{r[e.label||e.value||""]=0}),t.forEach(e=>{e.value_json&&Array.isArray(e.value_json)&&e.value_json.forEach(e=>{void 0!==r[e]&&(r[e]++,s++)})});let o=t.length,n=Object.entries(r).map(([e,t])=>({option:e,count:t,selection_percentage:s>0?parseFloat((t/s*100).toFixed(1)):0,respondent_percentage:o>0?parseFloat((t/o*100).toFixed(1)):0}));return{chart_data:n,total_responses:o,total_selections:s,avg_selections_per_response:o>0?parseFloat((s/o).toFixed(2)):0,most_selected:n.length>0?n.reduce((e,t)=>t.count>e.count?t:e):null}}(e,s);break;case"likert":r=function(e,t){let r={},s=[1,2,3,4,5,6,7];s.forEach(e=>{r[e]=0});let o=0,n=0;t.forEach(e=>{if(null!==e.value_numeric&&void 0!==e.value_numeric){let t=Number(e.value_numeric);s.includes(t)&&(r[t]++,o++,n+=t)}});let a=Object.entries(r).map(([e,t])=>({rating:Number(e),count:t,percentage:o>0?parseFloat((t/o*100).toFixed(1)):0}));return{chart_data:a,total_responses:o,average_rating:o>0?parseFloat((n/o).toFixed(2)):0,median_rating:function(e){let t=e.map(e=>e.value_numeric).filter(e=>null!=e).sort((e,t)=>e-t);if(0===t.length)return 0;let r=Math.floor(t.length/2);return t.length%2==0?(t[r-1]+t[r])/2:t[r]}(t),distribution:a}}(0,s);break;case"text":r=function(e){let t=e.filter(e=>e.value_text&&e.value_text.trim().length>0).map(e=>({text:e.value_text,length:e.value_text.length,word_count:e.value_text.split(/\s+/).filter(e=>e.length>0).length})),r=function(e){let t={},r=new Set(["el","la","los","las","un","una","de","que","y","en","a","con"]);return e.forEach(e=>{e.toLowerCase().replace(/[^\w\sáéíóúñ]/g,"").split(/\s+/).filter(e=>e.length>2&&!r.has(e)).forEach(e=>{t[e]=(t[e]||0)+1})}),Object.entries(t).sort((e,t)=>t[1]-e[1]).map(([e,t])=>({word:e,count:t}))}(t.map(e=>e.text)),s=t.length>0?t.reduce((e,t)=>e+t.length,0)/t.length:0,o=t.length>0?t.reduce((e,t)=>e+t.word_count,0)/t.length:0;return{total_responses:t.length,sample_responses:t.slice(0,10),word_frequencies:r.slice(0,20),average_length:Math.round(s),average_word_count:Math.round(o),shortest_response:t.length>0?t.reduce((e,t)=>t.length<e.length?t:e,t[0]):null,longest_response:t.length>0?t.reduce((e,t)=>t.length>e.length?t:e,t[0]):null}}(s);break;default:r={type:e.type,unsupported:!0}}return{id:e.id,question_text:e.question_text,type:e.type,required:e.required,position:e.position,response_count:s.length,analytics:r,options:e.survey_options||[]}}))}async function p(e,t){let r=new Date;r.setDate(r.getDate()-7);let{data:s,error:o}=await e.from("responses").select("submitted_at").eq("survey_id",t).gte("submitted_at",r.toISOString()).order("submitted_at",{ascending:!0});if(o)return console.error("Error fetching response trend:",o),[];let n={};s?.forEach(e=>{let t=new Date(e.submitted_at).toISOString().split("T")[0];n[t]=(n[t]||0)+1});let a=[];for(let e=6;e>=0;e--){let t=new Date;t.setDate(t.getDate()-e);let r=t.toISOString().split("T")[0];a.push({date:r,count:n[r]||0})}return a}let d=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/surveys/[id]/analytics/route",pathname:"/api/surveys/[id]/analytics",filename:"route",bundlePath:"app/api/surveys/[id]/analytics/route"},resolvedPagePath:"C:\\Projects\\MM100922-DevOps-QR\\app\\api\\surveys\\[id]\\analytics\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:h}=d,m="/api/surveys/[id]/analytics/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},30474:(e,t,r)=>{r.d(t,{R:()=>n});var s=r(71615),o=r(16510);function n(){let e=(0,s.cookies)();return(0,o.createServerClient)("https://jfagkzxzkbslpohhojuh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmYWdrenh6a2JzbHBvaGhvanVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDIyNjQsImV4cCI6MjA3ODAxODI2NH0.y8rKE8CyNK54GkqRRDalX5hyPy1YrG8NVj6mr2sgKPU",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:s})=>{e.set(t,r,s)})}catch{}}}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,223,972],()=>r(4916));module.exports=s})();