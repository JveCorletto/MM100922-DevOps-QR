(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[28],{57722:function(e,t,s){Promise.resolve().then(s.bind(s,20997))},20997:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return p}});var i=s(57437),n=s(2265),a=s(16463),l=s(88726),r=s(19783);function o(e){let{surveyId:t}=e,[s,a]=(0,n.useState)([]),[r,o]=(0,n.useState)(!0),[u,p]=(0,n.useState)({type:"text",title:"",required:!1,options:[]}),h=(0,n.useMemo)(()=>"text"!==u.type,[u.type]),[g,x]=(0,n.useState)(null),[j,m]=(0,n.useState)(null),[v,b]=(0,n.useState)(!1),[y,f]=(0,n.useState)(!1),[N,C]=(0,n.useState)(!1),k=async()=>{o(!0);let e=await fetch("/api/surveys/".concat(t,"/questions"));if(!e.ok){o(!1),l.ZP.error("No se pudieron cargar las preguntas");return}a(await e.json()),o(!1)};(0,n.useEffect)(()=>{k()},[t]);let w=e=>p(t=>({...t,options:t.options.filter((t,s)=>s!==e)})),P=async e=>{if(e.preventDefault(),!u.title.trim()){l.ZP.error("La pregunta necesita un enunciado");return}C(!0);let s={type:u.type,title:u.title.trim(),required:u.required,options:h?u.options:[]},i=await fetch("/api/surveys/".concat(t,"/questions"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(C(!1),!i.ok){let e=await i.json().catch(()=>({}));l.ZP.error(e.error||"No se pudo agregar");return}await k(),l.ZP.success("Pregunta agregada"),p({type:"text",title:"",required:!1,options:[]})};return(0,i.jsxs)("div",{className:"grid two",style:{marginTop:"1rem"},children:[(0,i.jsxs)("section",{className:"card",children:[(0,i.jsx)("h2",{style:{marginTop:0},children:"Preguntas"}),r?(0,i.jsx)("p",{children:"Cargando preguntas…"}):0===s.length?(0,i.jsx)("p",{children:"A\xfan no hay preguntas."}):(0,i.jsx)("ol",{style:{paddingLeft:"1.2rem"},children:s.map(e=>(0,i.jsx)("li",{style:{marginBottom:".6rem"},children:g&&g===e.id?(0,i.jsx)(d,{model:j,setModel:m,saving:v,onCancel:()=>{x(null),m(null)},onSave:async()=>{if(!j)return;if(!j.title.trim()){l.ZP.error("El enunciado es obligatorio");return}b(!0);let e=await fetch("/api/surveys/".concat(t,"/questions/").concat(j.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:j.type,title:j.title.trim(),required:j.required,options:"text"===j.type?[]:j.options})});if(b(!1),!e.ok){let t=await e.json().catch(()=>({}));l.ZP.error(t.error||"No se pudo guardar");return}l.ZP.success("Pregunta actualizada"),x(null),m(null),await k()}}):(0,i.jsx)(c,{q:e,onEdit:()=>{var t;x(e.id),m({id:e.id,type:e.type,title:e.title,required:e.required,options:[...null!==(t=e.options)&&void 0!==t?t:[]]})},onDelete:async()=>{f(!0);let s=await fetch("/api/surveys/".concat(t,"/questions/").concat(e.id),{method:"DELETE"});if(f(!1),!s.ok){let e=await s.json().catch(()=>({}));l.ZP.error(e.error||"No se pudo eliminar");return}l.ZP.success("Pregunta eliminada"),await k()},deleting:y})},e.id))})]}),(0,i.jsxs)("section",{className:"card",children:[(0,i.jsx)("h2",{style:{marginTop:0},children:"Nueva pregunta"}),(0,i.jsxs)("form",{onSubmit:P,className:"grid",style:{gap:".6rem"},children:[(0,i.jsxs)("div",{className:"grid grid-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Tipo"}),(0,i.jsxs)("select",{value:u.type,onChange:e=>p({...u,type:e.target.value,options:"text"===e.target.value?[]:u.options}),children:[(0,i.jsx)("option",{value:"text",children:"Texto libre"}),(0,i.jsx)("option",{value:"single",children:"Opci\xf3n \xfanica"}),(0,i.jsx)("option",{value:"multiple",children:"Opci\xf3n m\xfaltiple"}),(0,i.jsx)("option",{value:"likert",children:"Escala Likert"}),(0,i.jsx)("option",{value:"checkbox",children:"Casillas"})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Obligatoria"}),(0,i.jsxs)("select",{value:String(u.required),onChange:e=>p({...u,required:"true"===e.target.value}),children:[(0,i.jsx)("option",{value:"false",children:"No"}),(0,i.jsx)("option",{value:"true",children:"S\xed"})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Enunciado"}),(0,i.jsx)("input",{value:u.title,onChange:e=>p({...u,title:e.target.value}),required:!0})]}),h&&(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Opciones"}),(0,i.jsxs)("div",{className:"grid",style:{gap:".5rem"},children:[u.options.map((e,t)=>(0,i.jsxs)("div",{className:"grid grid-2",children:[(0,i.jsx)("input",{value:e.label,onChange:e=>{let s=[...u.options];s[t]={...s[t],label:e.target.value},p({...u,options:s})}}),(0,i.jsx)("button",{type:"button",className:"btn outline",onClick:()=>w(t),children:"Quitar"})]},t)),(0,i.jsx)("button",{type:"button",className:"btn",onClick:()=>p(e=>({...e,options:[...e.options,{label:"Opci\xf3n ".concat(e.options.length+1)}]})),children:"Agregar opci\xf3n"})]})]}),(0,i.jsx)("div",{className:"flex items-center",style:{justifyContent:"flex-end"},children:(0,i.jsx)("button",{className:"btn primary",type:"submit",disabled:N,children:N?"Agregando…":"Agregar pregunta"})})]})]})]})}function c(e){let{q:t,onEdit:s,onDelete:n,deleting:a}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("strong",{children:["(",t.type,")"]})," ",t.title," ",t.required?(0,i.jsx)("span",{className:"badge",children:"Obligatoria"}):null]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("button",{className:"btn outline",type:"button",onClick:s,children:"Editar"}),(0,i.jsx)("button",{className:"btn outline",type:"button",onClick:n,disabled:a,children:a?"Eliminando…":"Borrar"})]})]}),t.options&&t.options.length>0&&(0,i.jsx)("ul",{style:{marginTop:".25rem"},children:t.options.map((e,t)=>(0,i.jsx)("li",{children:e.label},t))})]})}function d(e){let{model:t,setModel:s,saving:n,onCancel:a,onSave:l}=e,r="text"!==t.type;return(0,i.jsx)("div",{className:"card",style:{background:"var(--panel)"},children:(0,i.jsxs)("div",{className:"grid",style:{gap:".6rem"},children:[(0,i.jsxs)("div",{className:"grid grid-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Tipo"}),(0,i.jsxs)("select",{value:t.type,onChange:e=>s({...t,type:e.target.value,options:"text"===e.target.value?[]:t.options}),children:[(0,i.jsx)("option",{value:"text",children:"Texto libre"}),(0,i.jsx)("option",{value:"single",children:"Opci\xf3n \xfanica"}),(0,i.jsx)("option",{value:"multiple",children:"Opci\xf3n m\xfaltiple"}),(0,i.jsx)("option",{value:"likert",children:"Escala Likert"}),(0,i.jsx)("option",{value:"checkbox",children:"Casillas"})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Obligatoria"}),(0,i.jsxs)("select",{value:String(t.required),onChange:e=>s({...t,required:"true"===e.target.value}),children:[(0,i.jsx)("option",{value:"false",children:"No"}),(0,i.jsx)("option",{value:"true",children:"S\xed"})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Enunciado"}),(0,i.jsx)("input",{value:t.title,onChange:e=>s({...t,title:e.target.value}),required:!0})]}),r&&(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Opciones"}),(0,i.jsxs)("div",{className:"grid",style:{gap:".5rem"},children:[t.options.map((e,n)=>(0,i.jsxs)("div",{className:"grid grid-2",children:[(0,i.jsx)("input",{value:e.label,onChange:e=>{let i=[...t.options];i[n]={...i[n],label:e.target.value},s({...t,options:i})}}),(0,i.jsx)("button",{type:"button",className:"btn outline",onClick:()=>{let e=t.options.filter((e,t)=>t!==n);s({...t,options:e})},children:"Quitar"})]},n)),(0,i.jsx)("button",{type:"button",className:"btn",onClick:()=>s({...t,options:[...t.options,{label:"Opci\xf3n ".concat(t.options.length+1)}]}),children:"Agregar opci\xf3n"})]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",style:{justifyContent:"flex-end"},children:[(0,i.jsx)("button",{className:"btn outline",type:"button",onClick:a,children:"Cancelar"}),(0,i.jsx)("button",{className:"btn primary",type:"button",onClick:l,disabled:n,children:n?"Guardando…":"Guardar"})]})]})})}async function u(e){try{await navigator.clipboard.writeText(e),l.ZP.success("Enlace copiado")}catch(e){l.ZP.error("No se pudo copiar")}}function p(){var e;let t=(0,a.useRouter)(),{id:s}=(0,a.useParams)(),[c,d]=(0,n.useState)(null),[p,h]=(0,n.useState)(!1),[g,x]=(0,n.useState)(!1),[j,m]=(0,n.useState)(""),[v,b]=(0,n.useState)([]),[y,f]=(0,n.useState)({type:"text",title:"",required:!1,options:[]});(0,n.useEffect)(()=>{(async()=>{let e=await fetch("/api/surveys/".concat(s));if(!e.ok){t.replace("/surveys");return}let i=await e.json();i.single_response="boolean"==typeof i.single_response&&i.single_response,i.single_response_scope=i.single_response_scope||"device",d(i);let n=await fetch("/api/surveys/".concat(s,"/questions"));n.ok&&b(await n.json())})()},[t,s]),(0,n.useEffect)(()=>{(async()=>{if(!(null==c?void 0:c.slug)){m("");return}let e="".concat(location.origin,"/s/").concat(c.slug);m(await r.toDataURL(e,{margin:2,scale:4}))})()},[null==c?void 0:c.slug]);let N=async e=>{var t;if(e.preventDefault(),!(null==c?void 0:c.title.trim()))return l.ZP.error("T\xedtulo requerido");h(!0);let i=await fetch("/api/surveys/".concat(s),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:c.title.trim(),description:null!==(t=c.description)&&void 0!==t?t:"",single_response:c.single_response,single_response_scope:c.single_response_scope})});if(h(!1),!i.ok){let e=await i.json().catch(()=>({}));return l.ZP.error(e.error||"No se pudo guardar")}l.ZP.success("Encuesta actualizada")},C=async()=>{x(!0);let e=await fetch("/api/surveys/".concat(s,"/status"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"publish"})});if(x(!1),!e.ok){let t=await e.json().catch(()=>({}));return l.ZP.error(t.error||"No se pudo publicar")}let{slug:t}=await e.json();l.ZP.success("Encuesta publicada"),d(e=>e?{...e,status:"published",slug:t}:e)};if((0,n.useMemo)(()=>"text"!==y.type,[y.type]),!c)return(0,i.jsx)("main",{className:"container section",children:(0,i.jsx)("div",{className:"card",children:(0,i.jsx)("p",{children:"Cargando…"})})});let k=c.slug?"".concat(location.origin,"/s/").concat(c.slug):"";return(0,i.jsxs)("main",{className:"container section",children:[(0,i.jsxs)("div",{className:"grid two",children:[(0,i.jsxs)("section",{className:"card",children:[(0,i.jsx)("h1",{style:{marginTop:0},children:"Editor de Encuesta"}),(0,i.jsxs)("form",{onSubmit:N,className:"grid",style:{gap:".75rem"},children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"T\xedtulo"}),(0,i.jsx)("input",{value:c.title,onChange:e=>d(t=>t?{...t,title:e.target.value}:t),required:!0})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Descripci\xf3n"}),(0,i.jsx)("textarea",{rows:3,value:null!==(e=c.description)&&void 0!==e?e:"",onChange:e=>d(t=>t?{...t,description:e.target.value}:t)})]}),(0,i.jsxs)("div",{className:"grid grid-2",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Una sola respuesta"}),(0,i.jsxs)("select",{value:String(c.single_response),onChange:e=>d(t=>t?{...t,single_response:"true"===e.target.value}:t),children:[(0,i.jsx)("option",{value:"false",children:"No"}),(0,i.jsx)("option",{value:"true",children:"S\xed"})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{children:"Alcance"}),(0,i.jsxs)("select",{value:c.single_response_scope,onChange:e=>d(t=>t?{...t,single_response_scope:e.target.value}:t),disabled:!c.single_response,title:c.single_response?void 0:"Activa 'Una sola respuesta' primero",children:[(0,i.jsx)("option",{value:"device",children:"Por dispositivo (token + huella)"}),(0,i.jsx)("option",{value:"user",children:"Por usuario autenticado"})]})]})]}),(0,i.jsxs)("div",{className:"stack",children:[(0,i.jsx)("button",{className:"btn primary",type:"submit",disabled:p,children:p?"Guardando…":"Guardar"}),(0,i.jsx)("button",{className:"btn",type:"button",onClick:C,disabled:g||"published"===c.status,children:"published"===c.status?"Publicado":g?"Publicando…":"Publicar"})]})]})]}),(0,i.jsxs)("section",{className:"card",children:[(0,i.jsx)("h2",{style:{marginTop:0},children:"QR & Enlace p\xfablico"}),c.slug?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("p",{children:"URL p\xfablica:"}),(0,i.jsx)("code",{style:{wordBreak:"break-all"},children:k}),(0,i.jsxs)("div",{className:"stack",style:{marginTop:".8rem"},children:[(0,i.jsx)("button",{className:"btn outline",onClick:()=>u(k),children:"Copiar enlace"}),j&&(0,i.jsx)("button",{className:"btn",onClick:()=>(function(e,t){let s=document.createElement("a");s.href=t,s.download=e,document.body.appendChild(s),s.click(),s.remove()})("qr-".concat(c.slug,".png"),j),children:"Descargar QR"})]}),(0,i.jsx)("div",{style:{marginTop:"1rem"},children:j?(0,i.jsx)("img",{src:j,alt:"QR",style:{width:200,height:200}}):(0,i.jsx)("p",{children:"Generando QR…"})})]}):(0,i.jsxs)("p",{children:["Publica la encuesta para generar un ",(0,i.jsx)("code",{children:"slug"})," y mostrar el QR."]})]})]}),(0,i.jsx)(o,{surveyId:s})]})}}},function(e){e.O(0,[726,32,971,23,744],function(){return e(e.s=57722)}),_N_E=e.O()}]);